---
title: "Problema 3 - Chekcpoint 2"
author: "Luiza Carvalho"
date: "28 de junho de 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(gridExtra)
library(ggplot2)
library(plotly)
```


Nesta análise será feito um agrupamento de dados com múltiplas variáveis utilizando o algoritmo k-means, os dados que serão utilizados e separados em grupos saã sobre a quantidade de falas de personagens de diferentes gêneros em filmes de hollywood.

## Trabalhando os dados

Os conjuntos de dados brutos utilizados foram o das tabelas de personagens e filmes, que continham respectivamente tais variáveis:   
 
```{r}
char <- read.csv('character_list5.csv')
names(char)

filmes <- read.csv('meta_data7.csv')
names(filmes)

```

Estes dados foram combinados e modificados para obter o conjunto de dados que será utilizado nessa análise. O conjunto da nossa análise possui variáveis como o id do script do filme, o nome do filme, o número total de personagens femininas, o número total de falas femininas, o número total de personagens masculinos e o número total de falas masculinas.

```{r}
dados = filmes %>% left_join(char)

#Removendo colunas irrelevantes

dados <- dados[ -c(2, 5, 10) ]

# Criando o data frame apenas com as personagens femininas e adicionando as colunas necessarias
dados_f <- dados %>% filter(gender == 'f')

dados_f <- dados_f %>% group_by(title, gender) %>% mutate(countf = n())
dados_f <- dados_f %>% group_by(title) %>% mutate(wordsf = sum(words))

# Criando o data frame apenas com os personagens masculinos e adicionando as colunas necessarias

dados_m <- dados %>% filter(gender == 'm')
dados_m <- dados_m %>% group_by(title, gender) %>% mutate(countm = n())
dados_m <- dados_m %>% group_by(title) %>% mutate(wordsm = sum(words))
  
# Removendo colunas que nao serao utilizadas

dados_f <- dados_f[ -c(4:7)]
dados_m <- dados_m[ -c(4:7)]

# Juntando os dados parar criar o conjunto de dados final
dados <- dados_f %>% left_join(dados_m)
dados <- unique(dados)


# Renomeando as variaveis
names(dados)[names(dados)=="script_id"] <- "Id"
names(dados)[names(dados)=="title"] <- "Filme"
names(dados)[names(dados)=="year"] <- "Ano"
names(dados)[names(dados)=="wordsf"] <- "Palavras.Ditas.por.Mulheres"
names(dados)[names(dados)=="wordsm"] <- "Palavras.Ditas.por.Homens"
names(dados)[names(dados)=="countf"] <- "Numero.de.Mulheres"
names(dados)[names(dados)=="countm"] <- "Numero.de.Homens"

# Excluindo os NA
dados <- na.omit(dados)

names(dados)

```

Muitos dados, como por exemplo o nome individual de cada personagem, seu número individual de palavras e sua idade, foi descartado. Pois o intuito dessa análise é avaliar o panorama geral sobre a quantidade de falas por gênero dos personagens em filmes de hollywood ao decorrer dos anos, assim fazendo uso da quantidade total de falas e de personagens de cada gênero, portanto todos os dados que não remetiam a essas informações foram descartados.

## Panorama das Mulheres nos Filmes

Antes de começar o agrupamento vamos observar o panorama geral das mulheres em Hollyood. Faremos isso comparando o gráfico do número de mulheres em filmes por ano com o seu equivalente masculino.

```{r}
ggplot(dados, aes(Ano,Numero.de.Mulheres, color = Palavras.Ditas.por.Mulheres, text = Filme)) + labs(title = "Número de Mulheres em Filmes por Ano") + geom_jitter() + scale_color_gradient(low="#efa0a3", high="#bc0007")

ggplot(dados, aes(Ano,Numero.de.Homens, color = Palavras.Ditas.por.Homens, text = Filme)) + labs(title = "Número de Homens em Filmes por Ano") + geom_jitter() + scale_color_gradient(low="#f49fdc", high="#7a0258")


```

Observando os gráficos vemos que o número de homens em filmes tende a ser bem maior que o de mulheres, se concentrando na faixa de 5 a 15, enquanto para as mulheres 10 já é um número alto, elas se concentram na faixa de 1 a 5, estando a maioria dos filmes abaixo da linha de 6 mulheres. 

Agora avaliaremos os gráficos referentes a mediana de mulheres em filmes por ano e a mediana das falas das mulheres nos filmes por ano:

```{r}
dados1 <- dados %>% group_by(Ano) %>% mutate(medianaM = median(as.numeric(Numero.de.Mulheres)), medianaH = median(as.numeric(Numero.de.Homens)), MedFalaM = median(as.numeric(Palavras.Ditas.por.Mulheres)), MedFalaH = median(as.numeric(Palavras.Ditas.por.Homens)) )

dados1 <- dados1[-c(1,2,4:7)]
dados1 <- unique(dados1)

p <- ggplot(dados1, aes(Ano, medianaM)) + labs(title = "Mediana do Número de Mulheres em Filmes por Ano") + geom_line(color = "#597db7") + labs(y = "Mediana de Personagens Mulheres")

p1 <- ggplot(dados1, aes(Ano,MedFalaM)) + labs(title = "Mediana do Número de Falas Femininas em Filmes por Ano") + geom_line(color = "#7dcadb") + labs(y = "Mediana de Falas Femininas")

ggplotly(p, width = 800, height = 500)
ggplotly(p1, width= 800, height = 500)
```

Podemos observar que em ambos os casos não há um crescimento da participação feminina nos filmes. O número de mulheres costumava variar muito entre 1925 e 1985, a partir desse ano a variação diminuiu e a mediana de mulheres por filme começou a sempre se encontrar entre 2 e 4. Houveram picos de representatividade feminina (em números) nos anos 50, 60 e 63, esses picos foram refletidos no número de falas nos anos 50 e 63. Podemos observar também que o número de falas femininas vem caindo um pouco de 1932 para os dias atuais.

## Agrupamento

Serao utilizadas 4 variaveis para agrupar os dados:

1. O número de mulheres por filme
2. O total de falas femininas
3. O número de homens por filme
4. O total de falas masculinas

O algoritmo a ser usado sera o k-means. 

Para encontrar o número ideal de clusters usaremos um gráfico da soma de quadrados total dentro dos grupos para ajudar na seleção do número de grupos. O ponto que estiver em formato de 'cotovelo' será o escolhido como número apropriado de clusters.

```{r}

dados.agrup <- dados[-c(1,2)]
set.seed(44)

wss <- (nrow(dados.agrup)-1)*sum(apply(dados.agrup,2,var))
for (i in 2:15) wss[i] <- sum(kmeans(dados.agrup, 
  	centers=i)$withinss)
plot(1:15, wss, type="b", xlab="Number of Clusters",
  ylab="Within groups sum of squares")

# Nesse caso 3 é visto como o número apropriado então:

# Clustering 
dadosCluster <- kmeans(dados.agrup, 3, nstart = 40)

aggregate(dados.agrup,by=list(dadosCluster$cluster),FUN=mean)

# append cluster 
dados.agrup <- data.frame(dados.agrup, dadosCluster$cluster)

names(dados.agrup)[names(dados.agrup)=="dadosCluster.cluster"] <- "cluster"

p1 <- dados.agrup %>% filter(cluster=='1') %>%
  plot_ly(type = 'parcoords',
          line = list(color ="#c97cc4"),
          dimensions = list(
            list(range = c(0,16),
                 label = 'Número de Mulheres', values = ~Numero.de.Mulheres),
            list(range = c(90,26000),
                 label = 'Palavras Ditas por Mulheres', values = ~Palavras.Ditas.por.Mulheres),
            list(range = c(0,30),
                 label = 'Número de Homens', values = ~Numero.de.Homens),
            list(range = c(90,57950),
                 label = 'Palavras Ditas por Homens', values = ~Palavras.Ditas.por.Homens)
            )
          )
p2 <- dados.agrup %>% filter(cluster=='2') %>%
  plot_ly(type = 'parcoords',
          line = list(color ="#ef5d8b"),
      dimensions = list(
            list(range = c(0,16),
                 label = 'Número de Mulheres', values = ~Numero.de.Mulheres),
            list(range = c(90,26000),
                 label = 'Palavras Ditas por Mulheres', values = ~Palavras.Ditas.por.Mulheres),
            list(range = c(0,30),
                 label = 'Número de Homens', values = ~Numero.de.Homens),
            list(range = c(90,57950),
                 label = 'Palavras Ditas por Homens', values = ~Palavras.Ditas.por.Homens)
            )
          )
p3 <- dados.agrup %>% filter(cluster=='3') %>%
  plot_ly(type = 'parcoords',
          line = list(color ="#9961c6"),
          dimensions = list(
            list(range = c(0,16),
                 label = 'Número de Mulheres', values = ~Numero.de.Mulheres),
            list(range = c(90,26000),
                 label = 'Palavras Ditas por Mulheres', values = ~Palavras.Ditas.por.Mulheres),
            list(range = c(0,30),
                 label = 'Número de Homens', values = ~Numero.de.Homens),
            list(range = c(90,57950),
                 label = 'Palavras Ditas por Homens', values = ~Palavras.Ditas.por.Homens)
            )
          )



p1

p2

p3
```

1. A caracteristica principal desse grupo é o fato de que há pouquíssimas falas masculinas, há uma variância grande entre o número de personagens femininas, mas as suas falas se concentram abaixo das 15 mil palavras. Os personagens masculinos se concentram abaixo de 15 e suas falas abaixo de 10 mil;  

2. O que marca esse grupo é o fato das falas e personagens femininas estarem variando bastante (contendo filmes que apresentam muitas, mas também uma quantidade alta de filmes com poucas), porém, apesar do número mediano de homens ser a norma nesse grupo a quantidade de falas masculinas é pouca ao compararmos com o número máximo (pois ao comparar com as falas femininas eles estariam em uma situação mediana para alta);

3. Esse grupo apresenta filmes onde o número de falas femininas tende a ser menor do que 10 mil (sendo medianas ou baixas comparadas ao número máximo de falas feminas), cujo número de homens varia muito, porém sempre se encontra maior que 2 e o número de falas masculinas está concentrado entre 40 mil e e 10 mil.

Os grupos nos mostram que há uma tendência pequena de quando mulheres falam mais (primeiro grupo) haver menos falas masculinas do que o normal, no entanto o número pequeno de falas masculinas ainda é maior que o número médio de falas femininas. Além disso pudemos observar que quanto menos mulheres tem papéis com fala (terceiro grupo) mais cresce as falas de homens nos filmes, sendo o número destas muito maior do que o número alto de falas femininas. Temos que Hollywood tem muito o que melhorar quando consideramos o panorama de gênero nos filmes, e que a indústria cinematográfica vem se mantendo quase que estática nesse quesito.
